#' Summarize nitrogen removal along a flowpath
#'
#' Nitrogen removal varies along a flowpath as they include different land cover
#' and waterbody types that have different nitrogen reduction capabilities.
#' This function takes a flowpath generated by
#' \code{\link{nsink_generate_flowpath}} as required input and returns and
#' estimate of total flow path removal as well as removal by type.
#'
#'
#' @param flowpath a flowpath to summarize nitrogen removal
#' @param removal the removal raster stack or removal list, generated by
#'                \code{\link{nsink_calc_removal}}
#' @param method a character string which determines if the caclulations are
#'               done using the raster method or a hybrid method
#'               (not currently implemented).
#' @param filter_window A numeric value indicating the size of the filter
#'                      window. Default value is 3.  See argument description
#'                      for \code{width} from \code{\link{rollmax}}. Only used
#'                      if the raster method is chosen.
#' @return A data frame is returned that with a summary of nitrogen removal
#'
#' @importFrom zoo rollmax
#' @importFrom raster rasterize extract
#' @export
#' @examples
#' \dontrun{
#' library(nsink)
#' library(sf)
#' library(lwgeom)
#' niantic_huc <- nsink_get_huc_id("Niantic River")$huc_12
#' niantic_data <- nsink_get_data(niantic_huc)
#' aea <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0
#' +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
#' niantic_nsink_data <- nsink_prep_data(niantic_huc, projection = aea)
#' removal <- nsink_calc_removal(niantic_nsink_data)
#' pt <- c(1948121,2295822)
#' start_loc <- st_sf(st_sfc(st_point(c(pt)), crs = aea))
#' fp <- nsink_generate_flowpath(start_loc, niantic_nsink_data)
#' nsink_summarize_flowpath(fp, removal)
#' pt <- c(1956582, 2287697)
#' start_loc <- st_sf(st_sfc(st_point(c(pt)), crs = aea))
#' fp <- nsink_generate_flowpath(start_loc, niantic_nsink_data,
#'                                      method = "hybrid")
#' nsink_summarize_flowpath(fp, removal, method = "hybrid")
#' }
#' TODO Raster method: Deal with adjacent hydrics, prior to entering stream
#'      network with different removal by combining and averaging?  If I get
#'      hybrid method working might not need to do this.
#' TODO Raster method: Remove hydric that occurs once flowpath enters the stream
#'      network. Replace with values from either side. If I get hybrid method
#'      working might not need to do this.
#'
nsink_summarize_flowpath <- function(flowpath, removal,
                                     method = c("raster", "hybrid"), filter_window = 3){
  method <- match.arg(method)
  if(method == "raster"){
    #fp_removal_raster <- rasterize(flowpath, removal$raster_method[[1]], 1, max) *
    #  removal$raster_method[[1]]
    #fp_type_raster <- rasterize(flowpath, removal$raster_method[[2]], 1, max) *
    #  removal$raster_method[[2]]
    remove <- raster::extract(removal$raster_method[[1]], flowpath, along = TRUE)[[1]]
    type <- extract(removal$raster_method[[2]], flowpath, along = TRUE)[[1]]
    remove <- rollmax(remove, filter_window)
    type <- rollmax(type, filter_window)
    total_removal <- nsink_calc_total_removal(remove) #This looks like what is left, not removal
    removal_summary <- nsink_create_summary(remove, type)
    #output <- list(flowpath_removal = fp_removal_raster,
    #               flowpath_type = fp_type_raster,
    #               total_removal = total_removal,
    #               removal_summary = removal_summary)
    return(removal_summary)
  } else if(method == "hybrid"){

    land_removal <- st_intersection(removal$land_removal, flowpath$flowpath_ends[[1]])

    land_removal_df <- data.frame(stream_comid = 0, lake_comid = 0,
                                  n_removal = land_removal$layer, segment_type = NA)
    land_removal_df <- mutate(land_removal_df,
                              segment_type = case_when(n_removal > 0 ~
                                                         1,
                                                       TRUE ~ 0),
                              n_removal = case_when(is.na(n_removal) ~ 0,
                                                       segment_type == 0 ~
                                                         0,
                                                       TRUE ~ n_removal),
                              segment_id = nsink_create_segment_ids(paste(segment_type,
                                                                          n_removal)),
                              length = as.numeric(st_length(land_removal)))

    #TODO get per segment removal from network
    if(!is.null(flowpath$flowpath_network)){
      n_removal_df <- select(st_drop_geometry(removal$network_removal),
                             stream_comid, n_removal)
      flowpath_removal <- left_join(flowpath$flowpath_network, n_removal_df)
      flowpath_removal_df <- st_drop_geometry(flowpath_removal)
      flowpath_removal_df <- unique(flowpath_removal_df)
      flowpath_removal_df <- mutate(flowpath_removal_df,
                                    segment_type =
                                      case_when(ftype == "ArtificialPath" ~
                                                  "Lake/Pond",
                                                ftype == "StreamRiver" ~
                                                  "Stream",
                                                TRUE ~ "Unknown"),
                                    length = lengthkm*1000)
      flowpath_removal_df <- select(flowpath_removal_df, stream_comid,
                                    lake_comid, n_removal, segment_type, length)
      flowpath_removal_df <- mutate(flowpath_removal_df,
                                    segment_id =
                                      nsink_create_segment_ids(paste(segment_type,
                                                                     n_removal)))
    } else {
      flowpath_removal_df <- NULL
    }
    # TODO NA in n_removal caused by missing time of travel.  See todo in nsink_calc_removal
    # TODO add it all together
    removal_summary <- nsink_create_summary_hybrid(land_removal_df, flowpath_removal_df)
    return(removal_summary)
  }
}

#' Calculate total nitrogen removal
#'
#' Nitrogen removal along a flowpath is determined by the types of landcover
#' encountered.  This function takes a vector of removal estimates and
#' calculates the total nitrogen removal for that flowpath.
#'
#' @param flowpath_vector a vector of removal values extracted from a nitrogen
#'                        removal raster generated by
#'                        \code{\link{nsink_calc_removal}}.

#' @return A single numeric vector for total nitrogen removal along the flowpath
#'
#' @importFrom zoo rollapply
#' @keywords internal
nsink_calc_total_removal <- function(flowpath_vector){
  fp_last <- zoo::rollapply(flowpath_vector, width = 2, partial = TRUE,
                            function(x) ifelse(x[1]==x[2],0, x[1]))
  fp_last <- ifelse(is.na(fp_last),flowpath_vector[length(flowpath_vector)],fp_last)
  fp_last_removal <- 1-fp_last
  total_removal <- cumprod(c(100,fp_last_removal))
  min(total_removal)
}

#' Create ID's for unique values in a vector
#'
#' This functions takes a vector of values and creates a unique ID for adjacent
#' and identical values.
#'
#' @param x a vector of values to create unique ID's
#'
#' @return a vector of unique ID's
#'
#' @keywords internal
nsink_create_segment_ids <- function(x){
  y<-vector("numeric", length(x))
  y_id<-vector("numeric", length(x))
  for(i in seq_along(x)){
    if(i == 1){
      y[i] <- i
    } else {
      y[i] <- ifelse(x[i]==x[i-1], FALSE,i)
    }
  }
  for(i in seq_along(y)){
    if(i == 1){
      y[1] <- y[1]
    } else {
      y[i] <- ifelse(y[i] == 0, y[i-1], y[i])
    }
  }
  y
}


#' Create a nitrogen removal summary
#'
#' This functions takes a nitrogen removal and removal type flowpath and creates
#' a data frame that summarizes the removal along that flowpath
#'
#' @param removal_vector A flowpath vector of nitrogen removal generated by
#'                       \code{\link{nsink_calc_removal}}.
#' @param type_vector A flowpath vector of removal type generated by
#'                    \code{\link{nsink_calc_removal}}.
#' @return a data frame summarizing nitrogen removal along a flowpath
#' @import dplyr
#' @keywords internal
nsink_create_summary <- function(removal_vector, type_vector){
  type_removal_df <- data.frame(type_code = type_vector,
                                removal = removal_vector,
                                stringsAsFactors = FALSE)
  type_removal_df <- mutate( type_removal_df,
                             segment_type = case_when(type_code == 0 ~ "No Removal",
                                                      type_code == 1 ~ "Hydric",
                                                      type_code == 2 ~ "Stream",
                                                      type_code == 3 ~ "Lake/Pond"),
                             segment_id = nsink_create_segment_ids(paste(type_code, removal)))
  type_removal_df <- group_by(type_removal_df, segment_id, segment_type)
  type_removal_df <- summarize(type_removal_df, length = n()*30,
                               n_removal = max(removal))
  type_removal_df <- ungroup(type_removal_df)
  n <- nrow(type_removal_df)
  output <- mutate(type_removal_df, n_in =
                       round(cumprod(c(100,1-n_removal))[-n],2),
                     n_out = round(cumprod(c(100,1-n_removal))[-1],2),
                     percent_removal = round(n_removal*100,3))
  output <- select(output, segment_type, length, percent_removal, n_in, n_out)
  output
}


#' Create a nitrogen removal summary using the hybrid method
#'
#' This functions takes a nitrogen removal and removal type data frame for land
#' and the flowpath network  and creates a data frame that summarizes the
#' removal along that flowpath.
#'
#' @param land_removal A data frame of land based nitrogen removal via the
#'                     generated flowpath and hydric removal raster.
#' @param network_removal A data frame of stream network nitrogen removal via
#'                        calculated stream and lake removal
#' @return a data frame summarizing nitrogen removal along a flowpath
#' @import dplyr
#' @keywords internal
nsink_create_summary_hybrid <- function(land_removal, network_removal){

  land_removal_df <- mutate(land_removal,
                            segment_type = case_when(segment_type == 0 ~ "No Removal",
                                                     segment_type == 1 ~ "Hydric",
                                                     segment_type == 2 ~ "Stream",
                                                     segment_type == 3 ~ "Lake/Pond"))
  land_removal_df <- group_by(land_removal_df, segment_id, segment_type)
  land_removal_df <- summarize(land_removal_df, length = sum(length),
                               n_removal = max(n_removal))
  land_removal_df <- ungroup(land_removal_df)

  wgt_avg_removal <- function(length, removal){
    sum(length*removal, na.rm = TRUE)/sum(length, na.rm = TRUE)
  }

  land_removal_df <- group_by(land_removal_df, segment_type)
  land_removal_df <- summarize(land_removal_df,
                               segment_id = max(segment_id),
                               n_removal = wgt_avg_removal(length, n_removal),
                               length = sum(length))
  land_removal_df <- ungroup(land_removal_df)
  land_removal_df <- select(land_removal_df, segment_id, segment_type, length,
                            n_removal)
  if(!is.null(network_removal)){
    network_removal_df <- select(network_removal, segment_id, segment_type,
                               length, n_removal)
    flowpath_removal_df <- rbind(land_removal_df, network_removal_df)
  } else {
    flowpath_removal_df <- land_removal_df
  }
  # Converting NA removal to 0 - need to have alternative.
  # see nsink_calc_removal TODO
  flowpath_removal_df <- mutate(flowpath_removal_df, n_removal =
                                  case_when(is.na(n_removal) ~ 0,
                                            TRUE ~ n_removal))

  n <- nrow(flowpath_removal_df)
  flowpath_removal_summary <- mutate(flowpath_removal_df,
                                     n_in = round(cumprod(c(100,1-n_removal))[-n],2),
                                     n_out = round(cumprod(c(100,1-n_removal))[-1],2),
                                     percent_removal = round(n_removal*100,3))
  flowpath_removal_summary <- select(flowpath_removal_summary, segment_type,
                                     length, percent_removal, n_in, n_out)

  flowpath_removal_summary
}


































